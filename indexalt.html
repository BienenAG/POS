<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Kassen-App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .app {
            display: flex;
            height: 100%;
            max-width: 1400px;
            margin: 0 auto;
            flex-direction: column;
            background: #ffffff;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        }
        
        @media (min-width: 768px) {
            .app {
                flex-direction: row;
            }
        }
        
        /* Product Panel Styles */
        .product-panel {
            flex: 1;
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            border-bottom: 1px solid #e8ecf1;
            overflow: hidden;
            position: relative;
            background: #fafbfc;
        }
        
        @media (min-width: 768px) {
            .product-panel {
                border-right: 1px solid #e8ecf1;
                border-bottom: none;
            }
        }
        
        .product-grid-container {
            flex-grow: 1;
            overflow: hidden;
            position: relative;
            margin-bottom: 1rem;
        }
        
        .product-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.9rem;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            padding-right: 0.5rem;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            touch-action: pan-y;
            cursor: grab;
        }
        
        .product-grid::-webkit-scrollbar {
            width: 6px;
        }
        
        .product-grid::-webkit-scrollbar-track {
            background: #f0f3f7;
            border-radius: 10px;
        }
        
        .product-grid::-webkit-scrollbar-thumb {
            background: #d0d8e0;
            border-radius: 10px;
        }
        
        .product-grid::-webkit-scrollbar-thumb:hover {
            background: #b8c1cc;
        }
        
        @media (min-width: 768px) {
            .product-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        .product-tile {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1.5px solid #e8ecf1;
            padding: 0.75rem 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
            position: relative;
            overflow: hidden;
        }
        
        .product-tile::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.12;
            z-index: 0;
            transition: opacity 0.25s ease;
        }
        
        .product-tile:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-color: #d8dfe8;
        }
        
        .product-tile:hover::before {
            opacity: 0.22;
        }
        
        .product-tile:active {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
        }
        
        .product-tile:active::before {
            opacity: 0.28;
        }
        
        .product-tile h4 {
            margin: 0 0 0.25rem 0;
            font-size: 0.95rem;
            font-weight: 600;
            color: #2c3e50;
            position: relative;
            z-index: 1;
            transition: color 0.25s ease;
        }
        
        .product-tile span {
            font-size: 0.9rem;
            font-weight: 700;
            color: #556b82;
            position: relative;
            z-index: 1;
            transition: color 0.25s ease;
        }
        
        .product-tile:hover h4,
        .product-tile:active h4 {
            color: #1a2a3a;
        }
        
        .product-tile:hover span,
        .product-tile:active span {
            color: #3a4a5a;
        }

        /* NEU: Lagerbestands-Warnung */
        .stock-warning {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #e74c3c; /* Rot */
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 0.2rem 0.4rem;
            border-radius: 0.4rem;
            z-index: 2;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 0.2rem;
        }
        
        /* Page Controls */
        .page-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            gap: 1rem;
        }
        
        .page-indicator-dots {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            flex: 1;
        }
        
        .page-dot {
            width: 8px;
            height: 8px;
            background-color: #d0d8e0;
            border-radius: 50%;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .page-dot.active {
            background-color: #a8b8cc;
            width: 24px;
            border-radius: 4px;
        }
        
        .settings-button {
            background: linear-gradient(135deg, #e8f0f8 0%, #f0f5fa 100%);
            border: 1.5px solid #d8dfe8;
            padding: 0.65rem;
            cursor: pointer;
            color: #556b82;
            border-radius: 0.65rem;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .settings-button:hover {
            background: linear-gradient(135deg, #dfe8f0 0%, #e8eff8 100%);
            border-color: #c8cfd8;
            color: #2c3e50;
            transform: translateY(-1px);
        }
        
        .settings-button svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }
        
        .management-link {
            padding: 0.65rem 1rem;
            background: linear-gradient(135deg, #e8f5f0 0%, #f0faf7 100%);
            color: #2d7a6a;
            text-decoration: none;
            border: 1.5px solid #d0e5df;
            border-radius: 0.65rem;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }
        
        .management-link:hover {
            background: linear-gradient(135deg, #dceee8 0%, #e8f8f2 100%);
            border-color: #b8d5cc;
            transform: translateY(-1px);
        }
        
        /* Cart Panel Styles */
        .cart-panel {
            width: 100%;
            max-height: 50vh;
            padding: 1.25rem;
            background: #fafbfc;
            display: flex;
            flex-direction: column;
            border-top: 1px solid #e8ecf1;
        }
        
        @media (min-width: 768px) {
            .cart-panel {
                width: 380px;
                max-height: none;
                border-top: none;
            }
        }
        
        .cart-panel h2 {
            font-size: 1.4rem;
            font-weight: 700;
            margin: 0 0 0.9rem 0;
            color: #2c3e50;
        }
        
        #cart-items {
            list-style: none;
            padding: 0;
            margin: 0 0 0.75rem 0;
            flex-grow: 1;
            overflow-y: auto;
        }
        
        #cart-items::-webkit-scrollbar {
            width: 5px;
        }
        
        #cart-items::-webkit-scrollbar-track {
            background: #f0f3f7;
            border-radius: 10px;
        }
        
        #cart-items::-webkit-scrollbar-thumb {
            background: #d0d8e0;
            border-radius: 10px;
        }
        
        .cart-item-wrapper {
            position: relative;
            overflow: hidden;
            border-radius: 0.65rem;
            margin-bottom: 0.5rem;
            touch-action: pan-y;
            --swipe-progress: 0;
        }
        
        .cart-item-wrapper::before {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ffb3b3 0%, #ffaaaa 100%);
            z-index: 1;
            opacity: calc(var(--swipe-progress) * 0.8);
            z-index: 0;
        }
        
        .cart-item-wrapper.swiping::before {
            opacity: 0.8;
        }
        
        .cart-item-wrapper.swiping .cart-item {
            color: #8b5a5a;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #ffffff;
            padding: 0.6rem 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            position: relative;
            z-index: 10;
            border-radius: 0.65rem;
            transition: transform 0.3s ease;
        }
        
        .cart-item-details {
            flex-grow: 1;
        }
        
        .cart-item-details h4 {
            margin: 0;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .cart-item-details span {
            font-size: 0.75rem;
            color: #888;
        }
        
        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            margin-right: 0.75rem;
        }
        
        .cart-item-controls button {
            background: #f0f3f7;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 1rem;
            font-weight: 700;
            color: #556b82;
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .cart-item-controls button:hover {
            background: #e8ecf1;
        }
        
        .cart-item-controls span {
            font-size: 0.9rem;
            font-weight: 600;
            min-width: 1.2rem;
            text-align: center;
        }
        
        .cart-item-price {
            font-size: 1rem;
            font-weight: 700;
            color: #2c3e50;
            min-width: 4rem;
            text-align: right;
        }
        
        .cart-summary {
            padding-top: 0.75rem;
            border-top: 1px solid #e8ecf1;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .summary-row span {
            font-size: 1rem;
            color: #556b82;
        }
        
        .summary-row.total {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e8ecf1;
        }
        
        .summary-row.total span {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .cart-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }
        
        .cart-actions button {
            flex: 1;
            padding: 0.8rem 1rem;
            border: none;
            border-radius: 0.65rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        #deposit-button {
            background: linear-gradient(135deg, #f0f5fa 0%, #e8eff8 100%);
            color: #556b82;
            border: 1.5px solid #d8dfe8;
        }
        
        #deposit-button:hover {
            background: linear-gradient(135deg, #e8eff8 0%, #dce5f0 100%);
            border-color: #c8cfd8;
        }
        
        #checkout-button {
            background: linear-gradient(135deg, #4CAF50 0%, #43A047 100%);
            color: white;
            border: 1.5px solid #388E3C;
        }
        
        #checkout-button:hover {
            background: linear-gradient(135deg, #43A047 0%, #388E3C 100%);
        }
        
        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            background: #ffffff;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 450px;
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .modal-overlay.active .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
            border-bottom: 1px solid #e8ecf1;
            padding-bottom: 0.75rem;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #a8b8cc;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        
        .modal-close:hover {
            color: #556b82;
        }
        
        /* Product Management List */
        .product-management-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }
        
        .product-management-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f0f3f7;
        }
        
        .product-management-item:last-child {
            border-bottom: none;
        }
        
        .product-management-item-details h4 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .product-management-item-details span {
            font-size: 0.85rem;
            color: #556b82;
        }
        
        .product-management-item-actions button {
            background: #f0f3f7;
            border: none;
            padding: 0.5rem;
            border-radius: 0.5rem;
            margin-left: 0.5rem;
            cursor: pointer;
            color: #556b82;
            transition: all 0.2s ease;
        }
        
        .product-management-item-actions button:hover {
            background: #e8ecf1;
            color: #2c3e50;
        }
        
        .product-management-actions {
            padding-top: 1rem;
            border-top: 1px solid #e8ecf1;
        }
        
        .add-product-button {
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(135deg, #5cb85c 0%, #4cae4c 100%);
            color: white;
            border: none;
            border-radius: 0.65rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .add-product-button:hover {
            background: linear-gradient(135deg, #4cae4c 0%, #449d44 100%);
        }
        
        /* Product Edit Modal */
        .product-edit-modal-content {
            background: #ffffff;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 450px;
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .modal-overlay.active .product-edit-modal-content {
            transform: scale(1);
            opacity: 1;
        }
        
        .product-edit-modal-content label {
            display: block;
            margin-top: 1rem;
            margin-bottom: 0.4rem;
            font-weight: 600;
            color: #556b82;
            font-size: 0.9rem;
        }
        
        .product-edit-modal-content input[type="text"],
        .product-edit-modal-content input[type="number"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d8dfe8;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }
        
        .product-edit-modal-content input[type="text"]:focus,
        .product-edit-modal-content input[type="number"]:focus {
            border-color: #a8b8cc;
            outline: none;
        }
        
        .color-picker-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .color-picker-grid button {
            width: 100%;
            height: 40px;
            border: 2px solid transparent;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .color-picker-grid button:hover {
            transform: scale(1.05);
        }
        
        .color-picker-grid button.selected {
            border-color: #2c3e50;
            box-shadow: 0 0 0 3px #ffffff, 0 0 0 5px #2c3e50;
        }
        
        .save-product-button {
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 0.65rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
            margin-top: 1.5rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .save-product-button:hover {
            background: linear-gradient(135deg, #2980b9 0%, #2471a3 100%);
        }
        
        /* Deposit Modal */
        .deposit-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-top: 1rem;
        }
        
        .deposit-grid button {
            padding: 1rem;
            background: linear-gradient(135deg, #f0f3f7 0%, #e8ecf1 100%);
            border: 1px solid #d8dfe8;
            border-radius: 0.65rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .deposit-grid button:hover {
            background: linear-gradient(135deg, #e8ecf1 0%, #d0d8e0 100%);
            transform: translateY(-1px);
        }
        
        #current-deposit-display {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: #f5f7fa;
            border-radius: 0.65rem;
        }
        
        .deposit-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }
        
        .deposit-actions button {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 0.65rem;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .deposit-actions .manual-input-button {
            background: linear-gradient(135deg, #f0f5fa 0%, #e8eff8 100%);
            color: #556b82;
            border: 1.5px solid #d8dfe8;
        }
        
        .deposit-actions .manual-input-button:hover {
            background: linear-gradient(135deg, #e8eff8 0%, #dce5f0 100%);
            border-color: #c8cfd8;
        }
        
        .deposit-actions .reset {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: 1.5px solid #a93226;
        }
        
        .deposit-actions .reset:hover {
            background: linear-gradient(135deg, #c0392b 0%, #922b21 100%);
        }
        
        /* Checkout Modal */
        .checkout-summary {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f5f7fa;
            border-radius: 0.65rem;
        }
        
        .checkout-summary .summary-row {
            margin-bottom: 0.75rem;
        }
        
        .checkout-summary .summary-row h4 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #556b82;
        }
        
        .checkout-summary .summary-row span {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .checkout-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }
        
        .checkout-grid button {
            padding: 1rem;
            background: linear-gradient(135deg, #f0f3f7 0%, #e8ecf1 100%);
            border: 1px solid #d8dfe8;
            border-radius: 0.65rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .checkout-grid button:hover {
            background: linear-gradient(135deg, #e8ecf1 0%, #d0d8e0 100%);
            transform: translateY(-1px);
        }
        
        .checkout-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }
        
        .checkout-actions button {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 0.65rem;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .checkout-actions .manual-input-button {
            background: linear-gradient(135deg, #f0f5fa 0%, #e8eff8 100%);
            color: #556b82;
            border: 1.5px solid #d8dfe8;
        }
        
        .checkout-actions .manual-input-button:hover {
            background: linear-gradient(135deg, #e8eff8 0%, #dce5f0 100%);
            border-color: #c8cfd8;
        }
        
        .checkout-actions .reset {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: 1.5px solid #a93226;
        }
        
        .checkout-actions .reset:hover {
            background: linear-gradient(135deg, #c0392b 0%, #922b21 100%);
        }
        
        .checkout-actions .finish {
            background: linear-gradient(135deg, #4CAF50 0%, #43A047 100%);
            color: white;
            border: 1.5px solid #388E3C;
        }
        
        .checkout-actions .finish:hover {
            background: linear-gradient(135deg, #43A047 0%, #388E3C 100%);
        }
        
        /* Numpad Modal */
        .numpad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-top: 1rem;
        }
        
        .numpad-grid button {
            padding: 1rem;
            background: linear-gradient(135deg, #f0f3f7 0%, #e8ecf1 100%);
            border: 1px solid #d8dfe8;
            border-radius: 0.65rem;
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .numpad-grid button:hover {
            background: linear-gradient(135deg, #e8ecf1 0%, #d0d8e0 100%);
            transform: translateY(-1px);
        }
        
        .numpad-grid button.action-button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            font-size: 1.1rem;
        }
        
        .numpad-grid button.action-button:hover {
            background: linear-gradient(135deg, #2980b9 0%, #2471a3 100%);
        }
        
        #numpad-display {
            text-align: right;
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: #f5f7fa;
            border-radius: 0.65rem;
        }
        
        /* Settings Modal */
        .settings-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .setting-group {
            padding: 1rem;
            border: 1px solid #e8ecf1;
            border-radius: 0.75rem;
            background: #fcfcfc;
        }
        
        .setting-group h4 {
            margin-top: 0;
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .setting-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #556b82;
        }
        
        .setting-group input[type="text"] {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid #d8dfe8;
            border-radius: 0.5rem;
            font-size: 0.95rem;
        }
        
        .setting-group button {
            margin-top: 0.5rem;
            padding: 0.6rem 1rem;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .setting-group button:hover {
            background: linear-gradient(135deg, #2980b9 0%, #2471a3 100%);
        }
        
        /* Donation Notification */
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* NEU: Lagerbestands-Steuerung Styles (Minimal) */
        .inventory-toggle-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 1rem;
            padding: 0.75rem;
            border: 1px solid #e8ecf1;
            border-radius: 0.5rem;
            background: #fcfcfc;
        }

        .inventory-toggle-group label {
            margin: 0;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1rem;
        }

        .inventory-toggle-group .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
        }

        .inventory-toggle-group .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .inventory-toggle-group .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .inventory-toggle-group .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        .inventory-toggle-group input:checked + .slider {
            background-color: #4CAF50;
        }

        .inventory-toggle-group input:focus + .slider {
            box-shadow: 0 0 1px #4CAF50;
        }

        .inventory-toggle-group input:checked + .slider:before {
            transform: translateX(16px);
        }

        #product-stock-input-group {
            margin-top: 1rem;
            padding: 0.75rem;
            border: 1px solid #e8ecf1;
            border-radius: 0.5rem;
            background: #fcfcfc;
        }

        #product-stock-input-group label {
            margin-top: 0;
        }

        #product-stock-input-group input {
            margin-top: 0.4rem;
        }

    </style>
</head>
<body>
    <div class="app">
        <div class="product-panel">
            <div class="product-grid-container">
                <div id="product-grid" class="product-grid">
                    <!-- Produktkacheln werden hier eingefügt -->
                </div>
            </div>
            <div class="page-controls">
                <a href="#" class="management-link" onclick="showProductManagementMenu()">
                    <i class="fas fa-box"></i>
                    Produkte verwalten
                </a>
                <div id="page-indicator-dots" class="page-indicator-dots">
                    <!-- Seitenindikatoren werden hier eingefügt -->
                </div>
                <button class="settings-button" onclick="showSettingsMenu()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Pro 6.0.0-beta3 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2021 Fonticons, Inc. --><path d="M495.9 166.6c3.1 8.7-1.5 18.4-10.2 21.5l-120.4 43.1 120.4 43.1c8.7 3.1 13.3 12.8 10.2 21.5l-48 134.1c-3.1 8.7-12.8 13.3-21.5 10.2l-120.4-43.1-120.4 43.1c-8.7 3.1-18.4-1.5-21.5-10.2l-48-134.1c-3.1-8.7 1.5-18.4 10.2-21.5l120.4-43.1-120.4-43.1c-8.7-3.1-13.3-12.8-10.2-21.5l48-134.1c3.1-8.7 12.8-13.3 21.5-10.2l120.4 43.1 120.4-43.1c8.7-3.1 18.4 1.5 21.5 10.2l48 134.1zM256 336c-44.18 0-80-35.82-80-80s35.82-80 80-80 80 35.82 80 80-35.82 80-80 80z"/></svg>
                </button>
            </div>
        </div>

        <div class="cart-panel">
            <h2>Warenkorb</h2>
            <ul id="cart-items"></ul>
            <div id="cart-summary">
                <div class="summary-row">
                    <span>Zwischensumme:</span>
                    <span id="subtotal">0,00 €</span>
                </div>
                <div class="summary-row">
                    <span>Pfandrückgabe:</span>
                    <span id="deposit-return">0,00 €</span>
                </div>
                <div class="summary-row total">
                    <span>Gesamt:</span>
                    <span id="total">0,00 €</span>
                </div>
            </div>
            <div class="cart-actions">
                <button id="deposit-button" onclick="showDepositMenu()">Pfandrückgabe</button>
                <button id="checkout-button" onclick="showCheckoutMenu()">Bezahlen</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="product-management-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Produkte verwalten</h3>
                <button class="modal-close" onclick="closeProductManagementMenu()">×</button>
            </div>
            <ul id="product-management-list" class="product-management-list">
            </ul>
            <div class="product-management-actions">
                <button class="add-product-button" onclick="openProductEditModal('new')"><i class="fas fa-plus"></i> Neues Produkt</button>
            </div>
        </div>
    </div>

    <div id="product-edit-modal" class="modal-overlay">
        <div class="product-edit-modal-content">
            <div class="modal-header">
                <h3 id="product-edit-title">Produkt bearbeiten</h3>
                <button class="modal-close" onclick="closeProductEditModal()">×</button>
            </div>
            <div>
                <label for="product-name-input">Produktname</label>
                <input type="text" id="product-name-input" placeholder="z.B. Kaffee">
                <label for="product-price-input">Preis (€)</label>
                <input type="number" step="0.01" id="product-price-input" placeholder="z.B. 2.50">

                <!-- NEU: Lagerbestands-Steuerung -->
                <div class="inventory-toggle-group">
                    <button style="background: none; border: none; padding: 0; margin-right: 0.5rem; color: #2c3e50; cursor: default;" onclick="event.preventDefault();">
                        <i class="fas fa-box"></i>
                    </button>
                    <label for="product-stock-enabled-toggle">Lagerbestand verfolgen</label>
                    <label class="toggle-switch" style="margin-left: auto;">
                        <input type="checkbox" id="product-stock-enabled-toggle" onchange="toggleStockInput()">
                        <span class="slider"></span>
                    </label>
                </div>

                <div id="product-stock-input-group" style="display: none;">
                    <label for="product-stock-input">Aktueller Lagerbestand</label>
                    <input type="number" step="1" min="0" id="product-stock-input" placeholder="Anzahl auf Lager">
                </div>
                <!-- ENDE NEU -->

                <label>Farbe wählen</label>
                <div id="color-picker-grid" class="color-picker-grid"></div>
                <button class="save-product-button" onclick="saveProduct()"><i class="fas fa-save"></i> Speichern</button>
            </div>
        </div>
    </div>

    <div id="deposit-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Pfandrückgabe</h3>
                <button class="modal-close" onclick="closeDepositMenu()">×</button>
            </div>
            <div id="current-deposit-display">0 Gläser</div>
            <div class="deposit-grid">
                <button onclick="addQuickDeposit(1)">1 Glas</button>
                <button onclick="addQuickDeposit(2)">2 Gläser</button>
                <button onclick="addQuickDeposit(3)">3 Gläser</button>
                <button onclick="addQuickDeposit(4)">4 Gläser</button>
                <button onclick="addQuickDeposit(5)">5 Gläser</button>
                <button onclick="addQuickDeposit(6)">6 Gläser</button>
                <button onclick="addQuickDeposit(7)">7 Gläser</button>
                <button onclick="addQuickDeposit(8)">8 Gläser</button>
                <button onclick="addQuickDeposit(9)">9 Gläser</button>
            </div>
            <div class="deposit-actions">
                <button class="manual-input-button" onclick="showNumpad(true)"><i class="fas fa-keyboard"></i> Manuelle Eingabe</button>
                <button class="reset" onclick="resetTotalDeposit()"><i class="fas fa-redo"></i> Zurücksetzen</button>
            </div>
        </div>
    </div>

    <div id="checkout-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Bezahlen</h3>
                <button class="modal-close" onclick="closeCheckoutMenu()">×</button>
            </div>
            <div class="checkout-summary">
                <div class="summary-row">
                    <h4>Gesamtbetrag:</h4>
                    <span id="checkout-total-display">0,00 €</span>
                </div>
                <div class="summary-row">
                    <h4>Erhalten:</h4>
                    <span id="received-amount-display">0,00 €</span>
                </div>
                <div class="summary-row">
                    <h4>Rückgeld:</h4>
                    <span id="change-display">0,00 €</span>
                </div>
            </div>
            <div class="checkout-grid">
                <button onclick="addQuickPayment(1)">1 €</button>
                <button onclick="addQuickPayment(2)">2 €</button>
                <button onclick="addQuickPayment(5)">5 €</button>
                <button onclick="addQuickPayment(10)">10 €</button>
                <button onclick="addQuickPayment(20)">20 €</button>
                <button onclick="addQuickPayment(50)">50 €</button>
            </div>
            <div class="checkout-actions">
                <button class="manual-input-button" onclick="showNumpad(false)"><i class="fas fa-keyboard"></i> Manuelle Eingabe</button>
                <button class="reset" onclick="resetReceivedAmount()"><i class="fas fa-redo"></i> Zurücksetzen</button>
                <button class="finish" onclick="finishCheckout()"><i class="fas fa-check"></i> Abschließen</button>
            </div>
        </div>
    </div>

    <div id="numpad-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Manuelle Eingabe</h3>
                <button class="modal-close" onclick="closeNumpad()">×</button>
            </div>
            <div id="numpad-display">0,00</div>
            <div class="numpad-grid">
                <button onclick="numpadInput('7')">7</button>
                <button onclick="numpadInput('8')">8</button>
                <button onclick="numpadInput('9')">9</button>
                <button onclick="numpadInput('4')">4</button>
                <button onclick="numpadInput('5')">5</button>
                <button onclick="numpadInput('6')">6</button>
                <button onclick="numpadInput('1')">1</button>
                <button onclick="numpadInput('2')">2</button>
                <button onclick="numpadInput('3')">3</button>
                <button onclick="numpadInput('0')">0</button>
                <button onclick="numpadInput(',')">,</button>
                <button class="action-button" onclick="numpadDelete()"><i class="fas fa-backspace"></i></button>
                <button class="action-button" style="grid-column: span 3;" onclick="numpadConfirm()"><i class="fas fa-check"></i> Bestätigen</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Einstellungen</h3>
                <button class="modal-close" onclick="closeSettingsMenu()">×</button>
            </div>
            <div class="settings-content">
                <div class="setting-group">
                    <h4>Kassen-ID</h4>
                    <label for="cash-register-id-input">Aktuelle Kassen-ID</label>
                    <input type="text" id="cash-register-id-input" placeholder="z.B. Kasse-1">
                    <button onclick="saveCashRegisterId()">Speichern</button>
                </div>
                <div class="setting-group">
                    <h4>API-Synchronisation</h4>
                    <p style="font-size: 0.9rem; color: #556b82;">
                        Die App synchronisiert automatisch alle 5 Sekunden Produkte und Warenkörbe über die simulierte API (localStorage).
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === Globale Variablen ===
        let products = [];
        let cart = [];
        let currentPage = 0;
        const productsPerPage = 8;
        let editingProductId = null;
        let editingProductColor = '';
        const pastelColors = [
            '#FFD1DC', '#FFABAB', '#FFC3A0', '#FF677D', '#D4A5A5', '#392F5A',
            '#A7BED3', '#C6E2E9', '#F4EAE6', '#E0BBE4', '#957DAD', '#D291BC'
        ];
        let totalDeposit = 0;
        let depositReturn = 0;
        let receivedAmount = 0;
        let numpadTarget = null; // 'deposit', 'payment', 'quantity'
        let numpadProductId = null; // Für Mengen-Eingabe
        let currentCashRegisterId = 'Kasse-1';
        let currentCashRegisterCartId = 'Kasse-1-Warenkorb';
        let donationAmount = 0;
        let donationPollInterval = null;
        let productPollInterval = null; // NEU: Für Produkt-Synchronisation

        // === Initialisierung ===
        document.addEventListener('DOMContentLoaded', () => {
            loadCashRegisterId();
            setupDonationAPI(); // Simuliert die API für Spenden
            setupProductAPI(); // Simuliert die API für Produkte
            setupCartAPI(); // Simuliert die API für Warenkörbe
            fetchProducts();
            fetchCartFromApi(currentCashRegisterCartId);
            startDonationPolling();
            startProductPolling(); // NEU: Starte Produkt-Synchronisation
        });

        // === Produkt-Synchronisation (NEU) ===
        function startProductPolling() {
            // Alle 5 Sekunden nach Produkt-Updates prüfen
            productPollInterval = setInterval(async () => {
                await fetchProducts();
            }, 5000);
        }

        // === API-Simulation für Produkte (Erweitert) ===
        function getProductsFromStorage() {
            const storedProducts = localStorage.getItem('products');
            // Minimalinvasive Änderung: Füge stockEnabled und stock zu den Standardprodukten hinzu
            return storedProducts ? JSON.parse(storedProducts) : [
                { id: 1, name: 'Kaffee', price: 2.50, color: '#FFD1DC', stockEnabled: true, stock: 15 },
                { id: 2, name: 'Tee', price: 2.00, color: '#FFABAB', stockEnabled: true, stock: 5 },
                { id: 3, name: 'Kuchen', price: 3.50, color: '#FFC3A0', stockEnabled: false, stock: 0 },
                { id: 4, name: 'Wasser', price: 1.50, color: '#FF677D', stockEnabled: true, stock: 20 },
                { id: 5, name: 'Saft', price: 2.80, color: '#D4A5A5', stockEnabled: false, stock: 0 },
                { id: 6, name: 'Muffin', price: 2.20, color: '#392F5A', stockEnabled: true, stock: 8 },
                { id: 7, name: 'Sandwich', price: 4.50, color: '#A7BED3', stockEnabled: false, stock: 0 },
                { id: 8, name: 'Salat', price: 5.00, color: '#C6E2E9', stockEnabled: true, stock: 12 },
                { id: 9, name: 'Brot', price: 3.00, color: '#F4EAE6', stockEnabled: true, stock: 9 },
                { id: 10, name: 'Milch', price: 1.20, color: '#E0BBE4', stockEnabled: false, stock: 0 },
            ];
        }

        function saveProductsToStorage(productsArray) {
            localStorage.setItem('products', JSON.stringify(productsArray));
        }

        async function fetchProducts() {
            // Simuliere API-Abruf
            const fetchedProducts = getProductsFromStorage();
            
            // Nur aktualisieren, wenn sich die Daten geändert haben (um unnötiges Neurendern zu vermeiden)
            if (JSON.stringify(products) !== JSON.stringify(fetchedProducts)) {
                products = fetchedProducts;
                renderProducts();
                renderProductManagementList();
            }
        }

        async function saveProducts() {
            // Simuliere API-Speicherung
            saveProductsToStorage(products);
            // Da die API-Simulation lokal ist, rufen wir fetchProducts auf, um die UI zu aktualisieren
            // In einer echten Anwendung würde dies ein POST/PUT an den Server sein
            // und fetchProducts würde die Daten von dort abrufen.
            await fetchProducts();
        }

        // === Kassen-ID Funktionen (Unverändert) ===
        function loadCashRegisterId() {
            const storedId = localStorage.getItem('cashRegisterId');
            if (storedId) {
                currentCashRegisterId = storedId;
                currentCashRegisterCartId = `${storedId}-Warenkorb`;
            }
            document.getElementById('cart-id-display').textContent = currentCashRegisterId;
        }

        function saveCashRegisterId() {
            const input = document.getElementById('cash-register-id-input');
            const newId = input.value.trim();
            if (newId && newId !== currentCashRegisterId) {
                localStorage.setItem('cashRegisterId', newId);
                currentCashRegisterId = newId;
                currentCashRegisterCartId = `${newId}-Warenkorb`;
                document.getElementById('cart-id-display').textContent = currentCashRegisterId;
                alert(`Kassen-ID auf "${newId}" gespeichert. Warenkorb-ID ist jetzt "${currentCashRegisterCartId}".`);
                closeSettingsMenu();
                // Warenkorb neu laden, um den neuen ID-basierten Warenkorb zu verwenden
                fetchCartFromApi(currentCashRegisterCartId);
            } else if (newId === currentCashRegisterId) {
                closeSettingsMenu();
            } else {
                alert("Bitte geben Sie eine gültige Kassen-ID ein.");
            }
        }

        // === Produkt-Rendering (Minimalinvasive Änderung) ===
        function renderProducts() {
            const grid = document.getElementById("product-grid");
            if (!grid) return;
            grid.innerHTML = "";

            const start = currentPage * productsPerPage;
            const end = start + productsPerPage;
            const productsOnPage = products.slice(start, end);

            productsOnPage.forEach(product => {
                const tile = document.createElement("div");
                tile.className = "product-tile";
                tile.style.backgroundColor = product.color;
                tile.onclick = () => addToCart(product);

                // NEU: Lagerbestands-Warnung
                let stockWarningHtml = '';
                if (product.stockEnabled && product.stock < 10) {
                    stockWarningHtml = `<div class="stock-warning"><i class="fas fa-exclamation-triangle"></i> ${product.stock}</div>`;
                }

                tile.innerHTML = `
                    ${stockWarningHtml}
                    <h4>${product.name}</h4>
                    <span>${product.price.toFixed(2).replace('.', ',')} €</span>
                `;
                grid.appendChild(tile);
            });

            renderPageDots();
        }

        function renderPageDots() {
            const dotsContainer = document.getElementById("page-indicator-dots");
            if (!dotsContainer) return;
            dotsContainer.innerHTML = "";

            const totalPages = Math.ceil(products.length / productsPerPage);

            for (let i = 0; i < totalPages; i++) {
                const dot = document.createElement("div");
                dot.className = `page-dot ${i === currentPage ? 'active' : ''}`;
                dot.onclick = () => {
                    currentPage = i;
                    renderProducts();
                };
                dotsContainer.appendChild(dot);
            }
        }

        // === Warenkorb-Funktionen (Minimalinvasive Änderung) ===
        function addToCart(product) {
            // NEU: Bestandsprüfung
            if (product.stockEnabled) {
                const currentCartQuantity = cart.filter(item => item.id === product.id).reduce((sum, item) => sum + item.quantity, 0);
                if (product.stock <= currentCartQuantity) {
                    alert(`Fehler: Der Artikel "${product.name}" ist ausverkauft!`);
                    return;
                }
            }

            const existingItem = cart.find(item => item.id === product.id);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    color: product.color,
                    quantity: 1
                });
            }
            renderCart();
            saveCartToApi();
        }

        function removeFromCart(productId) {
            const itemIndex = cart.findIndex(item => item.id === productId);
            if (itemIndex > -1) {
                if (cart[itemIndex].quantity > 1) {
                    cart[itemIndex].quantity--;
                } else {
                    cart.splice(itemIndex, 1);
                }
                renderCart();
                saveCartToApi();
            }
        }

        function removeAllFromCart(productId) {
            const itemIndex = cart.findIndex(item => item.id === productId);
            if (itemIndex > -1) {
                cart.splice(itemIndex, 1);
                renderCart();
                saveCartToApi();
            }
        }

        function renderCart() {
            const cartItems = document.getElementById("cart-items");
            if (!cartItems) return;

            cartItems.innerHTML = "";

            if (cart.length === 0) {
                const emptyMessage = document.createElement("li");
                emptyMessage.textContent = "Warenkorb ist leer";
                emptyMessage.style.textAlign = "center";
                emptyMessage.style.color = "#a8b8cc";
                emptyMessage.style.padding = "1.5rem 1rem";
                emptyMessage.style.fontSize = "1rem";
                cartItems.appendChild(emptyMessage);
            } else {
                cart.forEach(item => {
                    const li = document.createElement("li");
                    li.className = "cart-item-wrapper";
                    li.dataset.itemId = item.id;
                    
                    // Touch-Event-Listener für Wischgeste hinzufügen
                    li.addEventListener('touchstart', (e) => handleCartTouchStart(e, item.id), { passive: false });
                    li.addEventListener('touchmove', (e) => handleCartTouchMove(e, li), { passive: false });
                    li.addEventListener('touchend', (e) => handleCartTouchEnd(e, item.id, li), { passive: false });

                    li.innerHTML = `
                        <div class="cart-item">
                            <div class="cart-item-details">
                                <h4>${item.name}</h4>
                                <span>${item.quantity}x ${item.price.toFixed(2).replace('.', ',')} €</span>
                            </div>
                            <div class="cart-item-controls">
                                <button onclick="removeFromCart(${item.id})">−</button>
                                <span>${item.quantity}</span>
                                <button onclick="addToCart({id: ${item.id}, name: '${item.name}', price: ${item.price}, color: '${item.color}'})">+</button>
                                <button onclick="showNumpadForQuantity(${item.id})" style="margin-left: 0.3rem;"><i class="fas fa-keyboard"></i></button>
                            </div>
                            <div class="cart-item-price">
                                ${(item.price * item.quantity).toFixed(2).replace('.', ',')} €
                            </div>
                        </div>
                    `;
                    cartItems.appendChild(li);
                });
            }
            updateTotal();
        }

        // === Kassen- und API-Funktionen ===
        function updateTotal() {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const total = subtotal - depositReturn + donationAmount;

            document.getElementById("subtotal").textContent = subtotal.toFixed(2).replace('.', ',') + " €";
            document.getElementById("deposit-return").textContent = depositReturn.toFixed(2).replace('.', ',') + " €";
            document.getElementById("total").textContent = total.toFixed(2).replace('.', ',') + " €";
            document.getElementById("checkout-total-display").textContent = total.toFixed(2).replace('.', ',') + " €";

            updateChangeDisplay();
        }

        // === WICHTIGE ÄNDERUNG: finishCheckout (Bestandsreduzierung) ===
        async function finishCheckout() {
            const total = parseFloat(document.getElementById("total").textContent.replace(' €', '').replace(',', '.'));
            const change = receivedAmount - total;

            if (receivedAmount < total) {
                alert("Der erhaltene Betrag ist zu gering.");
                return;
            }

            // NEU: Lagerbestände aktualisieren
            const productsToUpdate = {};
            cart.forEach(item => {
                productsToUpdate[item.id] = item.quantity;
            });

            if (Object.keys(productsToUpdate).length > 0) {
                await updateStock(productsToUpdate);
            }

            // Warenkorb leeren und API aktualisieren
            cart = [];
            depositReturn = 0;
            receivedAmount = 0;
            donationAmount = 0;
            
            renderCart();
            saveCartToApi();
            closeCheckoutMenu();
            
            alert(`Zahlung erfolgreich! Rückgeld: ${change.toFixed(2).replace('.', ',')} €`);
        }

        // === NEUE FUNKTIONEN FÜR LAGERBESTAND (Minimal) ===

        function toggleStockInput() {
            const toggle = document.getElementById("product-stock-enabled-toggle");
            const inputGroup = document.getElementById("product-stock-input-group");
            if (toggle.checked) {
                inputGroup.style.display = "block";
            } else {
                inputGroup.style.display = "none";
            }
        }

        function showNumpadForQuantity(productId) {
            numpadTarget = 'quantity';
            numpadProductId = productId;
            document.getElementById("numpad-display").textContent = "0";
            document.getElementById("numpad-modal").style.display = "flex";
            document.getElementById("numpad-modal").classList.add("active");
            document.querySelector('#numpad-modal .modal-header h3').textContent = "Menge eingeben";
        }

        function numpadConfirm() {
            const value = document.getElementById("numpad-display").textContent.replace(',', '.');
            const num = parseFloat(value);

            if (numpadTarget === 'quantity' && numpadProductId !== null) {
                if (isNaN(num) || num <= 0 || !Number.isInteger(num)) {
                    alert("Bitte geben Sie eine gültige ganze Zahl > 0 ein.");
                    return;
                }

                const product = products.find(p => p.id === numpadProductId);
                const cartItem = cart.find(item => item.id === numpadProductId);

                if (product && cartItem) {
                    // NEU: Bestandsprüfung bei Mengenänderung
                    if (product.stockEnabled) {
                        const maxQuantity = product.stock;
                        if (num > maxQuantity) {
                            alert(`Fehler: Maximaler Bestand für "${product.name}" ist ${maxQuantity}.`);
                            return;
                        }
                    }

                    cartItem.quantity = num;
                    renderCart();
                    saveCartToApi();
                }
                numpadProductId = null;
            } else if (numpadTarget === 'deposit') {
                // Bestehende Logik
                totalDeposit += num;
                depositReturn = totalDeposit * 0.15;
                document.getElementById("current-deposit-display").textContent = `${totalDeposit} Gläser`;
                updateTotal();
            } else if (numpadTarget === 'payment') {
                // Bestehende Logik
                receivedAmount = num;
                updateChangeDisplay();
            }

            closeNumpad();
        }

        async function updateStock(productsToUpdate) {
            // Führt die Bestandsreduzierung durch und speichert die Produkte über die API
            let updated = false;
            products = products.map(product => {
                if (productsToUpdate[product.id]) {
                    const quantitySold = productsToUpdate[product.id];
                    // Prüfe, ob stockEnabled existiert und true ist
                    if (product.stockEnabled) {
                        product.stock = Math.max(0, product.stock - quantitySold);
                        updated = true;
                    }
                }
                return product;
            });

            if (updated) {
                await saveProducts();
            }
        }

        // === Ende NEUE FUNKTIONEN ===

        // === Warenkorb-API-Simulation (Unverändert) ===
        function getCartFromStorage(cartId) {
            const storedCart = localStorage.getItem(`cart_${cartId}`);
            return storedCart ? JSON.parse(storedCart) : { cart: [], depositReturn: 0, receivedAmount: 0 };
        }

        function saveCartToStorage(cartId, cartData) {
            localStorage.setItem(`cart_${cartId}`, JSON.stringify(cartData));
        }

        async function saveCartToApi() {
            // Simuliere API-Speicherung
            const cartData = {
                cart: cart,
                depositReturn: depositReturn,
                receivedAmount: receivedAmount
            };
            saveCartToStorage(currentCashRegisterCartId, cartData);
            // In einer echten Anwendung würde dies ein POST/PUT an den Server sein
        }

        async function fetchCartFromApi(cartId) {
            try {
                // Simuliere API-Abruf
                const data = getCartFromStorage(cartId);
                if (data) {
                    cart = data.cart || [];
                    depositReturn = data.depositReturn || 0;
                    receivedAmount = data.receivedAmount || 0;
                    renderCart();
                    updateTotal();
                }
            } catch (error) {
                console.error("Fehler beim Laden des Warenkorbs von der API.", error);
            }
        }

        function setupCartAPI() {
            // Simuliere API-Endpunkte für Warenkorb (falls benötigt, aber hier direkt über Funktionen)
        }

        // === Spenden-Funktionalität (Unverändert) ===
        let donationAmount = 0;
        let donationPollInterval = null;

        function startDonationPolling() {
            // Alle 2 Sekunden nach Spenden-Updates prüfen
            donationPollInterval = setInterval(async () => {
                await checkForDonationUpdates();
            }, 2000);
        }

        function stopDonationPolling() {
            if (donationPollInterval) {
                clearInterval(donationPollInterval);
                donationPollInterval = null;
            }
        }

        async function checkForDonationUpdates() {
            try {
                const response = await fetch(`${window.location.origin}/api/donation?cartId=${currentCashRegisterCartId}`);
                if (response.ok) {
                    const data = await response.json();
                    const newDonationAmount = data.donationAmount || 0;
                    
                    if (newDonationAmount !== donationAmount) {
                        donationAmount = newDonationAmount;
                        updateTotal();
                        
                        // Zeige Benachrichtigung bei neuer Spende
                        if (newDonationAmount > 0) {
                            showDonationNotification(newDonationAmount);
                        }
                    }
                }
            } catch (error) {
                console.error('Fehler beim Prüfen von Spenden-Updates:', error);
            }
        }

        function showDonationNotification(amount) {
            // Erstelle eine temporäre Benachrichtigung
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #c8e6d8 0%, #b8dcc8 100%);
                color: #2d7a6a;
                padding: 1rem 1.25rem;
                border-radius: 0.75rem;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
                z-index: 10000;
                font-weight: 600;
                animation: slideInRight 0.3s ease-out;
                border: 1.5px solid #a8cdb8;
            `;
            notification.innerHTML = `
                <i class="fas fa-heart" style="margin-right: 0.5rem;"></i>
                Neue Spende: ${amount.toFixed(2).replace('.', ',')} €
            `;

            // Füge CSS-Animation hinzu (falls noch nicht vorhanden)
            if (!document.querySelector('style[data-animation="slideInRight"]')) {
                const style = document.createElement('style');
                style.setAttribute('data-animation', 'slideInRight');
                style.textContent = `
                    @keyframes slideInRight {
                        from {
                            opacity: 0;
                            transform: translateX(100%);
                        }
                        to {
                            opacity: 1;
                            transform: translateX(0);
                        }
                    }
                `;
                document.head.appendChild(style);
            }

            document.body.appendChild(notification);

            // Entferne Benachrichtigung nach 3 Sekunden
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // === API-Endpunkte für Spenden (Simuliert) ===
        function getDonationFromStorage(cartId) {
            const donations = JSON.parse(localStorage.getItem('donations') || '{}');
            return donations[cartId] || { donationAmount: 0, timestamp: null };
        }

        function saveDonationToStorage(cartId, donationAmount) {
            const donations = JSON.parse(localStorage.getItem('donations') || '{}');
            donations[cartId] = {
                donationAmount: donationAmount,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('donations', JSON.stringify(donations));
        }

        function setupDonationAPI() {
            // Überschreibe fetch für lokale API-Simulation
            const originalFetch = window.fetch;
            window.fetch = function(url, options) {
                const urlObj = new URL(url, window.location.origin);
                
                // API-Route: GET /api/donation
                if (urlObj.pathname === '/api/donation' && (!options || options.method === 'GET')) {
                    const cartId = urlObj.searchParams.get('cartId');
                    if (cartId) {
                        const donation = getDonationFromStorage(cartId);
                        return Promise.resolve(new Response(JSON.stringify(donation), {
                            status: 200,
                            headers: { 'Content-Type': 'application/json' }
                        }));
                    }
                    return Promise.resolve(new Response('{"error": "cartId required"}', { status: 400 }));
                }
                
                // API-Route: POST /api/donation
                if (urlObj.pathname === '/api/donation' && options && options.method === 'POST') {
                    try {
                        const data = JSON.parse(options.body);
                        if (data.cartId && typeof data.donationAmount === 'number') {
                            saveDonationToStorage(data.cartId, data.donationAmount);
                            return Promise.resolve(new Response('{"success": true}', {
                                status: 200,
                                headers: { 'Content-Type': 'application/json' }
                            }));
                        }
                        return Promise.resolve(new Response('{"error": "Invalid data"}', { status: 400 }));
                    } catch (e) {
                        return Promise.resolve(new Response('{"error": "Invalid JSON"}', { status: 400 }));
                    }
                }

                // API-Route: GET /api/products
                if (urlObj.pathname === '/api/products' && (!options || options.method === 'GET')) {
                    const products = getProductsFromStorage();
                    return Promise.resolve(new Response(JSON.stringify(products), {
                        status: 200,
                        headers: { 'Content-Type': 'application/json' }
                    }));
                }

                // API-Route: POST /api/products
                if (urlObj.pathname === '/api/products' && options && options.method === 'POST') {
                    try {
                        const data = JSON.parse(options.body);
                        if (Array.isArray(data)) {
                            saveProductsToStorage(data);
                            return Promise.resolve(new Response('{"success": true}', {
                                status: 200,
                                headers: { 'Content-Type': 'application/json' }
                            }));
                        }
                        return Promise.resolve(new Response('{"error": "Invalid data, expected array"}', { status: 400 }));
                    } catch (e) {
                        return Promise.resolve(new Response('{"error": "Invalid JSON"}', { status: 400 }));
                    }
                }

                // API-Route: GET /api/cart
                if (urlObj.pathname === '/api/cart' && (!options || options.method === 'GET')) {
                    const cartId = urlObj.searchParams.get('cartId');
                    if (cartId) {
                        const cartData = getCartFromStorage(cartId);
                        return Promise.resolve(new Response(JSON.stringify(cartData), {
                            status: 200,
                            headers: { 'Content-Type': 'application/json' }
                        }));
                    }
                    return Promise.resolve(new Response('{"error": "cartId required"}', { status: 400 }));
                }

                // API-Route: POST /api/cart
                if (urlObj.pathname === '/api/cart' && options && options.method === 'POST') {
                    try {
                        const data = JSON.parse(options.body);
                        if (data.cartId && data.cart) {
                            saveCartToStorage(data.cartId, data);
                            return Promise.resolve(new Response('{"success": true}', {
                                status: 200,
                                headers: { 'Content-Type': 'application/json' }
                            }));
                        }
                        return Promise.resolve(new Response('{"error": "Invalid data"}', { status: 400 }));
                    } catch (e) {
                        return Promise.resolve(new Response('{"error": "Invalid JSON"}', { status: 400 }));
                    }
                }
                
                // Führe den ursprünglichen Fetch aus, wenn keine API-Route übereinstimmt
                return originalFetch(url, options);
            };
        }

        function setupProductAPI() {
            // Die Produkt-API-Simulation ist jetzt in setupDonationAPI integriert,
            // um alle simulierten Endpunkte an einem Ort zu haben.
        }

        // === Touch-Funktionen für Warenkorb (Unverändert) ===
        let touchStartX = 0;
        let touchStartY = 0;
        let isSwiping = false;

        function handleCartTouchStart(e, itemId) {
            if (e.touches.length === 1) {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                isSwiping = false;
            }
        }

        function handleCartTouchMove(e, li) {
            if (e.touches.length === 1) {
                const touchMoveX = e.touches[0].clientX;
                const touchMoveY = e.touches[0].clientY;
                const diffX = touchMoveX - touchStartX;
                const diffY = touchMoveY - touchStartY;

                // Nur horizontale Wischgeste verfolgen
                if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 10) {
                    isSwiping = true;
                    e.preventDefault(); // Verhindert vertikales Scrollen
                    
                    const swipeDistance = Math.min(0, Math.max(-150, diffX)); // Nur nach links wischen
                    const progress = Math.abs(swipeDistance) / 150;

                    li.style.setProperty('--swipe-progress', progress);
                    li.querySelector('.cart-item').style.transform = `translateX(${swipeDistance}px)`;
                    li.classList.add('swiping');
                }
            }
        }

        function handleCartTouchEnd(e, itemId, li) {
            li.classList.remove('swiping');
            li.style.setProperty('--swipe-progress', 0);
            li.querySelector('.cart-item').style.transform = `translateX(0)`;

            if (isSwiping) {
                const touchEndX = e.changedTouches[0].clientX;
                const diffX = touchEndX - touchStartX;

                if (diffX < -100) { // Weit genug nach links gewischt
                    removeAllFromCart(itemId);
                }
            }
            isSwiping = false;
        }

        // === Modal-Funktionen (Unverändert, außer openProductEditModal, saveProduct, renderProductManagementList) ===

        function showDepositMenu() {
            document.getElementById("deposit-modal").style.display = "flex";
            document.getElementById("deposit-modal").classList.add("active");
        }

        function closeDepositMenu() {
            document.getElementById("deposit-modal").style.display = "none";
            document.getElementById("deposit-modal").classList.remove("active");
        }

        function addQuickDeposit(count) {
            totalDeposit += count;
            depositReturn = totalDeposit * 0.15; // Angenommen 0.15€ pro Glas
            document.getElementById("current-deposit-display").textContent = `${totalDeposit} Gläser`;
            updateTotal();
        }

        function resetTotalDeposit() {
            totalDeposit = 0;
            depositReturn = 0;
            document.getElementById("current-deposit-display").textContent = `0 Gläser`;
            updateTotal();
        }

        function showCheckoutMenu() {
            if (cart.length === 0) {
                alert("Der Warenkorb ist leer.");
                return;
            }
            document.getElementById("checkout-modal").style.display = "flex";
            document.getElementById("checkout-modal").classList.add("active");
            updateChangeDisplay();
        }

        function closeCheckoutMenu() {
            document.getElementById("checkout-modal").style.display = "none";
            document.getElementById("checkout-modal").classList.remove("active");
        }

        function addQuickPayment(amount) {
            receivedAmount += amount;
            updateChangeDisplay();
        }

        function resetReceivedAmount() {
            receivedAmount = 0;
            updateChangeDisplay();
        }

        function updateChangeDisplay() {
            const total = parseFloat(document.getElementById("total").textContent.replace(' €', '').replace(',', '.'));
            const change = receivedAmount - total;

            document.getElementById("received-amount-display").textContent = receivedAmount.toFixed(2).replace('.', ',') + " €";
            document.getElementById("change-display").textContent = change.toFixed(2).replace('.', ',') + " €";

            const changeDisplay = document.getElementById("change-display");
            if (change < 0) {
                changeDisplay.style.color = '#e74c3c'; // Rot
            } else {
                changeDisplay.style.color = '#4CAF50'; // Grün
            }
        }

        let numpadValue = "0";
        let numpadIsDecimal = false;

        function showNumpad(isDeposit) {
            numpadTarget = isDeposit ? 'deposit' : 'payment';
            numpadValue = "0";
            numpadIsDecimal = false;
            document.getElementById("numpad-display").textContent = "0,00";
            document.getElementById("numpad-modal").style.display = "flex";
            document.getElementById("numpad-modal").classList.add("active");
            document.querySelector('#numpad-modal .modal-header h3').textContent = "Manuelle Eingabe";
        }

        function closeNumpad() {
            document.getElementById("numpad-modal").style.display = "none";
            document.getElementById("numpad-modal").classList.remove("active");
            numpadTarget = null;
        }

        function numpadInput(key) {
            if (key === ',') {
                if (!numpadIsDecimal) {
                    numpadIsDecimal = true;
                }
            } else {
                if (numpadTarget === 'quantity') {
                    // Für Menge: nur ganze Zahlen
                    if (numpadValue === "0") {
                        numpadValue = key;
                    } else {
                        numpadValue += key;
                    }
                } else {
                    // Für Währung: zwei Dezimalstellen
                    const numStr = numpadValue.replace(',', '');
                    if (numStr.length < 5) { // Maximal 999,99
                        if (numpadValue === "0") {
                            numpadValue = key;
                        } else {
                            numpadValue += key;
                        }
                    }
                }
            }

            let displayValue;
            if (numpadTarget === 'quantity') {
                displayValue = numpadValue;
            } else {
                const numStr = numpadValue.replace(',', '');
                if (numStr.length < 3) {
                    displayValue = "0," + numStr.padStart(2, '0');
                } else {
                    displayValue = numStr.slice(0, -2) + ',' + numStr.slice(-2);
                }
            }

            document.getElementById("numpad-display").textContent = displayValue;
        }

        function numpadDelete() {
            if (numpadValue.length > 1) {
                numpadValue = numpadValue.slice(0, -1);
            } else {
                numpadValue = "0";
            }

            let displayValue;
            if (numpadTarget === 'quantity') {
                displayValue = numpadValue;
            } else {
                const numStr = numpadValue.replace(',', '');
                if (numStr.length < 3) {
                    displayValue = "0," + numStr.padStart(2, '0');
                } else {
                    displayValue = numStr.slice(0, -2) + ',' + numStr.slice(-2);
                }
            }
            document.getElementById("numpad-display").textContent = displayValue;
        }

        // numpadConfirm wurde oben für Lagerbestand erweitert

        function showSettingsMenu() {
            document.getElementById('cash-register-id-input').value = currentCashRegisterId;
            document.getElementById("settings-modal").style.display = "flex";
            document.getElementById("settings-modal").classList.add("active");
        }

        function closeSettingsMenu() {
            document.getElementById("settings-modal").style.display = "none";
            document.getElementById("settings-modal").classList.remove("active");
        }

        function showProductManagementMenu() {
            document.getElementById("product-management-modal").style.display = "flex";
            document.getElementById("product-management-modal").classList.add("active");
            renderProductManagementList();
        }

        function closeProductManagementMenu() {
            document.getElementById("product-management-modal").style.display = "none";
            document.getElementById("product-management-modal").classList.remove("active");
        }

        function renderProductManagementList() {
            const list = document.getElementById("product-management-list");
            if (!list) return;
            list.innerHTML = "";

            products.forEach((product, index) => {
                const li = document.createElement("li");
                li.className = "product-management-item";

                // NEU: Lagerbestands-Info im Management-Menü
                const stockInfo = product.stockEnabled 
                    ? `<span style="color: ${product.stock < 10 ? '#e74c3c' : '#4CAF50'}; font-weight: 600; margin-left: 1rem;">Lager: ${product.stock}</span>`
                    : `<span style="color: #a8b8cc; margin-left: 1rem;">Lager: Aus</span>`;

                li.innerHTML = `
                    <div class="product-management-item-details">
                        <h4>${product.name}</h4>
                        <span>€ ${product.price.toFixed(2).replace('.', ',')}</span>
                        ${stockInfo}
                    </div>
                    <div class="product-management-item-actions">
                        <button title="Nach oben" onclick="moveProductUp(${product.id}, event)">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button title="Nach unten" onclick="moveProductDown(${product.id}, event)">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button title="Bearbeiten" onclick="openProductEditModal(${product.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button title="Löschen" onclick="deleteProduct(${product.id})">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;

                list.appendChild(li);
            });
        }

        // openProductEditModal (Minimalinvasive Änderung)
        function openProductEditModal(productId) {
            const modal = document.getElementById("product-edit-modal");
            if (!modal) return;
            modal.style.display = "flex";
            modal.classList.add("active");

            const title = document.getElementById("product-edit-title");
            const nameInput = document.getElementById("product-name-input");
            const priceInput = document.getElementById("product-price-input");
            const stockEnabledToggle = document.getElementById("product-stock-enabled-toggle");
            const stockInput = document.getElementById("product-stock-input");
            const colorGrid = document.getElementById("color-picker-grid");

            colorGrid.innerHTML = "";
            pastelColors.forEach(color => {
                const colorButton = document.createElement("button");
                colorButton.style.backgroundColor = color;
                colorButton.onclick = () => {
                    editingProductColor = color;
                    updateColorSelection();
                };
                colorGrid.appendChild(colorButton);
            });

            if (productId === 'new') {
                editingProductId = null;
                title.textContent = "Neues Produkt";
                nameInput.value = "";
                priceInput.value = "";
                stockEnabledToggle.checked = false; // NEU
                stockInput.value = 0; // NEU
                editingProductColor = pastelColors[0];
            } else {
                editingProductId = productId;
                const product = products.find(p => p.id === productId);
                if (product) {
                    title.textContent = "Produkt bearbeiten";
                    nameInput.value = product.name;
                    priceInput.value = product.price.toFixed(2);
                    // NEU: Lagerbestandsfelder setzen
                    stockEnabledToggle.checked = product.stockEnabled || false;
                    stockInput.value = product.stock || 0;
                    editingProductColor = product.color;
                }
            }
            toggleStockInput(); // Zeige/Verstecke das Bestandsfeld basierend auf dem Toggle-Status
            updateColorSelection();
        }

        function closeProductEditModal() {
            const modal = document.getElementById("product-edit-modal");
            if (!modal) return;
            modal.style.display = "none";
            modal.classList.remove("active");
        }

        function updateColorSelection() {
            const colorGrid = document.getElementById("color-picker-grid");
            Array.from(colorGrid.children).forEach(button => {
                button.classList.toggle("selected", button.style.backgroundColor === editingProductColor);
            });
        }

        // saveProduct (Minimalinvasive Änderung)
        async function saveProduct() {
            const nameInput = document.getElementById("product-name-input");
            const priceInput = document.getElementById("product-price-input");
            const stockEnabledToggle = document.getElementById("product-stock-enabled-toggle");
            const stockInput = document.getElementById("product-stock-input");

            const name = nameInput.value.trim();
            const price = parseFloat(priceInput.value);
            const stockEnabled = stockEnabledToggle.checked; // NEU
            const stock = stockEnabled ? parseInt(stockInput.value) : 0; // NEU

            if (!name || isNaN(price) || price < 0) {
                alert("Bitte geben Sie einen gültigen Namen und Preis ein.");
                return;
            }
            if (stockEnabled && (isNaN(stock) || stock < 0)) {
                alert("Bitte geben Sie einen gültigen Lagerbestand ein.");
                return;
            }

            if (editingProductId === null) {
                // Neues Produkt
                const newId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
                products.push({ 
                    id: newId, 
                    name, 
                    price, 
                    color: editingProductColor,
                    stockEnabled: stockEnabled, // NEU
                    stock: stock // NEU
                });
            } else {
                // Produkt bearbeiten
                const product = products.find(p => p.id === editingProductId);
                if (product) {
                    product.name = name;
                    product.price = price;
                    product.color = editingProductColor;
                    product.stockEnabled = stockEnabled; // NEU
                    product.stock = stock; // NEU
                }
            }

            await saveProducts();
            renderProducts();
            renderProductManagementList();
            closeProductEditModal();
        }

        async function deleteProduct(productId) {
            if (confirm("Sind Sie sicher, dass Sie dieses Produkt löschen möchten?")) {
                products = products.filter(p => p.id !== productId);
                await saveProducts();
                renderProducts();
                renderProductManagementList();
            }
        }

        function moveProductUp(productId, event) {
            event.stopPropagation();
            const index = products.findIndex(p => p.id === productId);
            if (index > 0) {
                [products[index - 1], products[index]] = [products[index], products[index - 1]];
                renderProductManagementList();
                saveProducts();
            }
        }

        function moveProductDown(productId, event) {
            event.stopPropagation();
            const index = products.findIndex(p => p.id === productId);
            if (index < products.length - 1) {
                [products[index], products[index + 1]] = [products[index + 1], products[index]];
                renderProductManagementList();
                saveProducts();
            }
        }
    </script>
</body>
</html>
